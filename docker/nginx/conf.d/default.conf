# 生产环境标准 Nginx 配置 - 双项目部署方案
# 1. 博客网站 (80 -> 443 重定向)
# 2. 管理端前端 (独立端口，如 8081)

# --- 1. 博客网站 HTTPS 重定向 ---
server {
    listen 80;
    server_name freecity.club; # 替换为你的博客域名

    # 强制跳转到 HTTPS
    return 301 https://$host$request_uri;
}

# --- 2. 博客网站 HTTPS 主服务器 ---
server {
    listen 443 ssl;
    server_name freecity.club; # 替换为你的博客域名

    ssl_certificate /etc/nginx/certs/my.crt;      # 替换为你的证书路径
    ssl_certificate_key /etc/nginx/certs/my.key;  # 替换为你的私钥路径
    
    # SSL 优化
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # 隐藏 Nginx 版本号（安全优化）
    # server_tokens off;
    client_max_body_size 50M;

    # 代理到后端应用
    location / {
        proxy_pass http://app:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        proxy_pass http://app:8080;
        expires 30d;
        add_header Cache-Control "public, no-transform";
        access_log off; # 减少静态资源日志 IO
    }

    # 禁止访问敏感文件
    location ~ /\.(ht|git|svn) {
        deny all;
    }

    # 文件上传目录静态访问
    location /uploads/ {
        alias /usr/share/nginx/html/uploads/;
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }
}

# --- 3. 管理端前端项目 (独立端口) ---
# 仅支持 HTTPS (需使用 https://ip:8443 访问)
server {
    listen 8443 ssl; # 管理端访问端口
    server_name freecity.club;

    ssl_certificate /etc/nginx/certs/my.crt;      
    ssl_certificate_key /etc/nginx/certs/my.key;  
    
    # SSL 优化
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # 隐藏 Nginx 版本号（安全优化）
    # server_tokens off;
    client_max_body_size 50M;

    # 文件上传目录静态访问 (提高优先级)
    location ^~ /uploads/ {
        alias /usr/share/nginx/html/uploads/;
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }

    # 管理端静态资源目录
    root /usr/share/nginx/html/admin;
    index index.html;

    # 解决前端路由 (如 Vue/React) 刷新 404 问题
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 管理端 API 请求转发到共同后端
    # 假设管理端请求都带 /api 前缀
    location /api/ {
        proxy_pass http://app:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 7d;
        add_header Cache-Control "public, no-transform";
        access_log off;
    }

    # 禁止访问敏感文件
    location ~ /\.(ht|git|svn) {
        deny all;
    }
}
